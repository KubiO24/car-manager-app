<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <title>Faktury</title>
    <style>
        .button {
            height: 30px;
            color: white;
        }

        .buttonGenerate {
            width: 150px;
            background-color: #57d8ff;
        }

        .buttonDownload {
            width: 90px;
            background-color: #56e059;
        }

        .buttonDownload:disabled {
            cursor: not-allowed;
            background-color: #9f9f9f;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="navbar">
        <a href="/">Index</a>
        <a href="cars.html">Edit / Update cars</a>
        <a class="selected" href="admin.html">Generate invoice</a>
        <a href="cars.html">Search invoices</a>
    </div>

    <div class="bottomSection">
        <table id="carTable">

        </table>
    </div>
</div>

  <script>
        let cars;

        updateData = () => {
            fetch('json')
                .then((response) => response.json())
                .then((data) => {
                    cars = data;
                    const table = document.querySelector("#carTable");
                    table.innerHTML = "";

                    for (const car of data) {
                        const row = document.createElement("tr");
                        for (const carKey of Object.keys(car)) {
                            const cell = document.createElement("td");

                            if(carKey === 'airbags') {
                                for(const airbag of car[carKey]) {
                                    const cellText = document.createTextNode(`${airbag['description']}: ${airbag['value']} `);
                                    cell.appendChild(cellText);
                                    cell.appendChild(document.createElement("br"));
                                }
                            }else if(carKey === 'color') {
                                cell.style.background = car[carKey];
                            }else {
                                const cellText = document.createTextNode(car[carKey]);
                                cell.appendChild(cellText);
                            }

                            row.appendChild(cell);
                        }

                        const generateCell = document.createElement("td");

                        const generateButton = document.createElement("button");
                        generateButton.innerText = "Generate VAT invoice";
                        generateButton.classList.add("button", "buttonGenerate");
                        generateButton.setAttribute('data-uuid', car['uuid']);
                        generateButton.onclick = generateInvoice;
                        generateCell.appendChild(generateButton);
                        row.appendChild(generateCell);

                        const downloadCell = document.createElement("td");
                        const downloadButton = document.createElement("button");
                        downloadButton.innerText = "Download";
                        downloadButton.classList.add("button", "buttonDownload");
                        downloadButton.setAttribute('data-uuid', car['uuid']);
                        downloadButton.disabled = true;
                        downloadButton.onclick = downloadInvoice;
                        downloadCell.appendChild(downloadButton);
                        row.appendChild(downloadCell);

                        table.appendChild(row);
                    }
                });
        }


        generateInvoice = (e) => {
            const uuid = e.target.getAttribute('data-uuid');
            const popupUpdateButton = document.querySelector("#popupUpdate");
            popupUpdateButton.setAttribute('data-uuid', uuid);
            popupUpdateButton.onclick = popupUpdate;
            document.querySelector('#popupBackground').style.display = "flex";
            for(const car of cars) {
                if(car['uuid'] == uuid) {
                    document.querySelector('#model').value = car['model'];
                    document.querySelector('#year').value = car['year'];
                }
            }
        }

        popupUpdate = async (e) => {
            const uuid = e.target.getAttribute('data-uuid');

            let result = await fetchUpdateAsync(uuid);
            if(result) {
                document.querySelector('#popupBackground').style.display = "none";
                updateData();
            }
        }

        fetchUpdateAsync = async (uuid) => {
          let model = document.querySelector("#model").value;
          if(model == "") return false;
          let year = document.querySelector("#year").value;

          const data = JSON.stringify({
              uuid: uuid,
              model: model,
              year: year,
          })

          const options = {
              method: "POST",
              body: data,
          };

          let response = await fetch("/update", options)

          if (!response.ok)
              return response.status
          else
              return await response.json() // response.json
        }
         downloadInvoice = () => {
            console.log("donwnload");
         }

        updateData();
    </script>
</body>
</html>